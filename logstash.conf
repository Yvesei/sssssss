input {
  beats {
    port => 5044
  }
}

filter {
  # Parse NCSA HTTP access logs
  grok {
    match => {
      "message" => '%{IP:client_ip} - %{DATA:user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{DATA:request} HTTP/%{NUMBER:http_version}" %{NUMBER:response_code} %{NUMBER:response_size} "%{DATA:referer}" "%{DATA:user_agent}"'
    }
  }
  
  mutate {
    convert => {
      "response_code" => "integer"
      "response_size" => "integer"
      "http_version" => "float"
    }
  }
  
  # Parse timestamp
  date {
    match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"]
    target => "@timestamp"
  }
  
  # Annotate attacks + MITRE ATT&CK mapping
  ruby {
    code => "
      ua = event.get('user_agent') || ''
      request = event.get('request') || ''
      
      attack = 'normal'
      technique = nil
      tactic = nil
      scenario = nil
      
      # XSS Detection
      if ua.include?('xss') or request =~ /<script|javascript:|onerror=/i
        attack = 'XSS_Attack'
        technique = 'T1059'  # Command and Scripting Interpreter
        tactic = 'Execution'
        scenario = 'T1059_XSS'
      
      # SQLi Detection
      elsif ua.include?('sqli') or request =~ /union.*select|' or |1=1|sleep\(|benchmark\(/i
        attack = 'SQLi_Attack'
        technique = 'T1190'  # Exploit Public-Facing Application
        tactic = 'Initial Access'
        scenario = 'T1190_SQLI'
      
      # Command Injection
      elsif ua.include?('command-injection') or request =~ /;.*cat|&&|\\|\\||`/
        attack = 'Command_Injection'
        technique = 'T1059.004'  # Unix Shell
        tactic = 'Execution'
        scenario = 'T1059_CMD_INJECTION'
      
      # Path Traversal
      elsif ua.include?('path-traversal') or request =~ /\\.\\.\\/|%2e%2e/i
        attack = 'Path_Traversal'
        technique = 'T1083'  # File and Directory Discovery
        tactic = 'Discovery'
        scenario = 'T1083_PATH_TRAVERSAL'
      
      # Jenkins Specific
      elsif ua.include?('jenkins')
        attack = 'Jenkins_Specific'
        technique = 'T1190'  # Exploit Public-Facing Application
        tactic = 'Initial Access'
        scenario = 'T1190_JENKINS'
      end
      
      event.set('attack_annotation', attack)
      event.set('[attack][technique]', technique) if technique
      event.set('[attack][tactic]', tactic) if tactic
      event.set('[scenario][id]', scenario) if scenario
      
      # Event label
      event.set('[event][label]', attack == 'normal' ? 'benign' : 'malicious')
    "
  }
  
  # Dataset category
  if [event][label] == "malicious" {
    mutate {
      add_field => { "[dataset][category]" => "attack" }
    }
  } else {
    mutate {
      add_field => { "[dataset][category]" => "normal" }
    }
  }
  
  # MITRE CAR format fields
  mutate {
    add_field => {
      "[car][object]" => "http"
      "[car][timestamp]" => "%{@timestamp}"
    }
  }

  # HTTP method -> car.action (lowercased)
  if [method] {
    mutate {
      copy => { "method" => "[car][action]" }
    }
    mutate {
      lowercase => [ "[car][action]" ]
    }
  }

  # URL fields
  if [request] {
    mutate {
      copy => { "request" => "[car][url_remainder]" }
    }
  }

  # Response fields
  if [response_code] {
    mutate {
      copy => { "response_code" => "[car][response_status_code]" }
    }
  }

  if [response_size] {
    mutate {
      copy => { "response_size" => "[car][response_body_bytes]" }
    }
  }

  # Source IP
  if [client_ip] {
    mutate {
      copy => { "client_ip" => "[car][src_ip]" }
    }
  }

  # User-Agent
  if [user_agent] {
    mutate {
      copy => { "user_agent" => "[car][user_agent_full]" }
    }
  }

  # HTTP version
  if [http_version] {
    mutate {
      copy => { "http_version" => "[car][http_version]" }
    }
  }

  # Referer
  if [referer] {
    mutate {
      copy => { "referer" => "[car][http_referrer]" }
    }
  }

  # User (if authenticated)
  if [user] and [user] != "-" {
    mutate {
      copy => { "user" => "[car][user]" }
    }
  }

  # Attack annotation
  if [attack_annotation] {
    mutate {
      copy => { "attack_annotation" => "[car][attack_type]" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "jenkins-logs-car-%{+YYYY.MM.dd}"
  }
}