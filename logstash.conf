input {
  beats {
    port => 5044
  }
}

filter {
  # Parse NCSA HTTP access logs
  grok {
    match => {
      "message" => '%{IP:client_ip} - %{DATA:user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{DATA:request} HTTP/%{NUMBER:http_version}" %{NUMBER:response_code} %{NUMBER:response_size} "%{DATA:referer}" "%{DATA:user_agent}"'
    }
  }
  
  mutate {
    convert => {
      "response_code" => "integer",
      "response_size" => "integer",
      "http_version" => "float"
    }
  }
  
  # Parse timestamp
  date {
    match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"]
    target => "@timestamp"
  }
  
  # Detect attack type and map to MITRE ATT&CK
  
  # SQLi Detection
  if [user_agent] =~ /sqli/i or [request] =~ /union.*select|' or |1=1|sleep\(|benchmark\(/i {
    mutate {
      add_field => {
        "attack_annotation" => "SQLi_Attack",
        "[attack][technique]" => "T1190",
        "[attack][tactic]" => "Initial Access",
        "[scenario][id]" => "T1190_SQLI",
        "[event][label]" => "malicious"
      }
    }
  }
  
  # XSS Detection
  else if [user_agent] =~ /xss/i or [request] =~ /<script|javascript:|onerror=/i {
    mutate {
      add_field => {
        "attack_annotation" => "XSS_Attack",
        "[attack][technique]" => "T1059",
        "[attack][tactic]" => "Execution",
        "[scenario][id]" => "T1059_XSS",
        "[event][label]" => "malicious"
      }
    }
  }
  
  # Command Injection
  else if [user_agent] =~ /command-injection/i or [request] =~ /;.*cat|&&|\|\||`/ {
    mutate {
      add_field => {
        "attack_annotation" => "Command_Injection",
        "[attack][technique]" => "T1059.004",
        "[attack][tactic]" => "Execution",
        "[scenario][id]" => "T1059_CMD_INJECTION",
        "[event][label]" => "malicious"
      }
    }
  }
  
  # Path Traversal
  else if [user_agent] =~ /path-traversal/i or [request] =~ /\.\.\/|%2e%2e/i {
    mutate {
      add_field => {
        "attack_annotation" => "Path_Traversal",
        "[attack][technique]" => "T1083",
        "[attack][tactic]" => "Discovery",
        "[scenario][id]" => "T1083_PATH_TRAVERSAL",
        "[event][label]" => "malicious"
      }
    }
  }
  
  # Jenkins Specific
  else if [user_agent] =~ /jenkins/i {
    mutate {
      add_field => {
        "attack_annotation" => "Jenkins_Specific",
        "[attack][technique]" => "T1190",
        "[attack][tactic]" => "Initial Access",
        "[scenario][id]" => "T1190_JENKINS",
        "[event][label]" => "malicious"
      }
    }
  }
  
  # Normal traffic (default)
  else {
    mutate {
      add_field => {
        "attack_annotation" => "normal",
        "[event][label]" => "benign"
      }
    }
  }
  
  # Dataset category based on event label
  if [event][label] == "malicious" {
    mutate {
      add_field => { "[dataset][category]" => "attack" }
    }
  } else {
    mutate {
      add_field => { "[dataset][category]" => "normal" }
    }
  }
  
  # ============================================================
  # MITRE CAR format fields
  # ============================================================
  mutate {
    add_field => {
      "[car][object]" => "http",
      "[car][timestamp]" => "%{@timestamp}"
    }
  }

  # HTTP method -> car.action (lowercased)
  if [method] {
    mutate {
      copy => { "method" => "[car][action]" }
    }
    mutate {
      lowercase => [ "[car][action]" ]
    }
  }

  # URL fields
  if [request] {
    mutate {
      copy => { "request" => "[car][url_remainder]" }
    }
  }

  # Response fields
  if [response_code] {
    mutate {
      copy => { "response_code" => "[car][response_status_code]" }
    }
  }

  if [response_size] {
    mutate {
      copy => { "response_size" => "[car][response_body_bytes]" }
    }
  }

  # Source IP
  if [client_ip] {
    mutate {
      copy => { "client_ip" => "[car][src_ip]" }
    }
  }

  # User-Agent
  if [user_agent] {
    mutate {
      copy => { "user_agent" => "[car][user_agent_full]" }
    }
  }

  # HTTP version
  if [http_version] {
    mutate {
      copy => { "http_version" => "[car][http_version]" }
    }
  }

  # Referer
  if [referer] {
    mutate {
      copy => { "referer" => "[car][http_referrer]" }
    }
  }

  # User (if authenticated)
  if [user] and [user] != "-" {
    mutate {
      copy => { "user" => "[car][user]" }
    }
  }

  # Attack annotation
  if [attack_annotation] {
    mutate {
      copy => { "attack_annotation" => "[car][attack_type]" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "jenkins-logs-car-%{+YYYY.MM.dd}"
  }
}